# Cartesi API Specification

Version: 0.0.1-wip

## Introduction

The Cartesi API Specification defines a standard, language-agnostic interface
to Cartesi DApps, to better document how to interact with the distributed
applications. The definition can be automatically generated from an existing
DApp and also used to generate both the DApp and client codes.

## Specifications

### Format

The Cartesi API Specification file is a JSON object, which may be represented
either in JSON or YAML format.

## Schema

### CartesiAPI Object

This is the root object of a Cartesi API Description document.

Fields:

| Field Name | Type   | Description |
| ---------- | ------ | ----------- |
| cartesiapi | string | **REQUIRED**. This must be the version of the CartesiAPI Specification for the current document, as a string. This is not related to the Dapp version, which should be in the `info.verion` key. |
| info       | [Info Object](#info-object) | **REQUIRED**. Provides metadata about the DApp. |
| operations | \[[Operation Object](#operation-object)\] | **REQUIRED**. Available ways to interact with the DApp. |
| components | [Components Object](#components-object) | Element to hold various schemas for the document |
| tags       | \[[Tag Object](#tag-object)\] | A list of tags used by the document with additional metadata. |
| externalDocs | [External Documentation Object](#external-documentation-object) | Additional external documentation |

### Info Object

Metadata about the DApp. These metadata may be used by the clients and may be
used to generate a presentation of the documentation.

Fields:

| Field Name | Type   | Description |
| ---------- | ------ | ----------- |
| title      | string | **REQUIRED**. The title of the DApp. |
| version    | string | **REQUIRED**. The version of the DApp. |
| summary    | string | A short summary of the DApp. |
| description | string | A long form description for the document. Can use Markdown for rich text representation. |
| termsOfService | string | A URL to the Terms of Service for the DApp. |
| license    | [License Object](#license-object) | The license information for the DApp |
| contact    | [Contact Object](#contact-object) | The contact information for the DApp |

### License Object

Licensing information for the DApp

Fields:

| Field Name | Type   | Description |
| ---------- | ------ | ----------- |
| name       | string | **REQUIRED**. The license name for the DApp. |
| identifier | string | An [SPDX](https://spdx.org/spdx-specification-21-web-version#h.jxpfx0ykyb60) license expression for the DApp. The `identifier` field is mutually exclusive of the `url` field. |
| url | string | A URL to the license used for the DApp. The `url` field is mutually exclusive of the `identifier` field. |

### Contact Object

Contact information for the DApp

Fields:

| Field Name | Type   | Description |
| ---------- | ------ | ----------- |
| name       | string | Name of the contact person/organization. |
| url        | string | The URL pointing to the contact information. |
| email      | string | The email address of the contact person/organization |

### Operation Object

Describe an operation offered by the DApp.

Fields:

| Field Name  | Type   | Description |
| ----------- | ------ | ----------- |
| operationId | string | **REQUIRED**. A unique string used to identify this operation. The id MUST be unique among all operations for this DApp. The `operationId` value is case-sensitive, and MAY be used by automated tools for code generation, therefore, it is recommended to follow common programming naming conventions. |
| namespace   | string | An optional namespace representing, for example, the library or framework that implements this operation. This will be used to compute a header. The default value should be an empty string (""). |
| summary     | string | A short summary for the operation. |
| description | string | A long form description for the operation. Can use Markdown for rich text representation. |
| externalDocs | [External Documentation Object](#external-documentation-object) | Additional external documentation for the opretaion. |
| tags | \[string\] | A list of tags for documentation control. Tags can be used for logical grouping of operations by resources or any other qualifier. |
| :memo: requestType | string | **REQUIRED**. The type of the operation for the Cartesi Machine. It MUST be either `"advance"` for requests that arrive via a Layer 1 call to addInput, or `"inspect"` for requests that arrive via inspect queries. |
| :memo: input | [Input Object](#input-object) \| [Reference Object](#reference-object) | A description of the expected input for this operation. |
| :memo: outputs | [Output Object](#output-object) | A description of the possible outputs generated by this operation. |
| :memo: sender | [Address Object](#address-object) \| [Reference Object](#reference-object) | Specifies who is allowed to call this operation. If not specified, no restrictions should be applied to the caller. This only applies when `requestType` is `advance`. |

Discussion points:

- Advances and Inspects are represented as the `requestType` field, instead of
  of having dedicated objects, as the format for the underlying operations, for
  the most part, can be identical.
- A msg_sender restriction is more akin to permissions than to input formatting.
  I think it should be specified in the Operation Level.

### Input Object

Describes how the input should be formed for the current operation.

Fixed Fields:

| Field Name  | Type   | Description |
| ----------- | ------ | ----------- |
| description | string | A long form description for the input. Can use Markdown for rich text representation. |
| contentType | string | **REQUIRED**. The type of the contents of this input. See discussions below for how to specify this format. |
| header      | string | Specify whether the content should be prefixed with a sequence of bytes, and how these bytes are formed. See discussion below. By default, `header` is `null`, meaning that nothing should be prepended to the input described by the `contentType` or `schema`. |
| selectors   | \[string\] | If no header is supplied, the `selectors` field specifies which fields of the schema are used by the application to match this operation. |
| schema      | [Schema Object](#schema-object) | The schema description for the input |
| pattern     | string | When `contentType` is `text/uri-list`, this field should be the URI pattern to be parsed. For other content types, this field must be `null`. |
| parameters  | \[[Parameter Object](#parameter-object)\] | When `contentType` is `text/uri-list`, this field should be a list of expected parameters in the URL, both in the path and query string. |

Discussion points:

- ContentType should be one of the following:
  - `ethereum/abi-packed`
  - `ethereum/abi`
  - `text/uri-list`
  - Any MIME type
- The `ethereum/abi` and `ethereum/abi-packed` types are not registered IANA
  media types. According to [RFC 6838](https://datatracker.ietf.org/doc/html/rfc6838), more appropriate names would be `application/x.ethereum.abi` or `application/x.ethereum.abi-packed` as tey use the unregistered facet tree.
- If using ABI or ABI-packed encoding, the types reported in the schema should be valid Solidity types.
- A null `header` means that nothing should be prefixed to the input.
- Header can be one of the following:
  - `operationId` to prefix the raw `operationId`
  - `functionKeccak`: the keccak256 for the concatenation of the following bytes:
    - keccak256 of the `namespace` field, representing the name of the library or framework
    - keccak256 of the `operationId`, which should correspond to the name of the function
    - keccak256 of the expected fields, enclosed in parentheses
    - See [go-rollups' ABI codec](https://github.com/prototyp3-dev/go-rollups/blob/main/handler/abi/codec.go) for reference.
  - `functionSelector`: first 4 bytes of the keccak256 checksum of the function signature, which is composed by the `operationId` and the data types for the parameters of the function.
- When the payload is expected to be an URL (like in a GET inspect):
  - `contentType` MUST be `text/uri-list` (see [RFC 2483](https://datatracker.ietf.org/doc/html/rfc2483#section-5))
  - payload MUST be a single URI without end-of-line characters
  - payload MUST be a relative, absolute path, URI (see `abs_path` definition of [RFC 2396](https://datatracker.ietf.org/doc/html/rfc2396#section-3)). This means that the first character must be `/`, and query and fragment parts are allowed.
  - the `pattern` field MUST be used to specify the URL pattern to be matched against the `path` part of the URL
  - the `parameters` field should be a list of expected parameters both in the path and query string

### Parameter Object

When the input of an operation is meant to be a URL, the parameter objects will
describe each expected parameter and its type.

| Field Name  | Type   | Description |
| ----------- | ------ | ----------- |
| name        | string | **REQUIRED**. The name of the parameter. Parameters name are case sensitive, and MUST correspond to how they are specified in the path or in the query string. |
| in          | string | **REQUIRED**. Where the parameter can be found. Possible values are `path` or `query`. |
| description | string | A description for the parameter. Can use Markdown for rich text representation. |
| schema      | [Schema Object](#schema-object) | The schema defining the type used for the parameter. |

### Schema Object

The Schema Object allows the definition of input and output data types and
format. This type is a superset of the
[OpenAPI Schema Object](https://swagger.io/specification/#schema-object) which,
in turn, is a superset of the [JSON Schema Specification](https://tools.ietf.org/html/draft-bhutton-json-schema-00).

The OpenAPI schema offers a flexible way of specifying inputs, with provisions
to XML formatting and type polymorphism. However, in order to support types
like ABI Encoded data, we must extend the definition to allow for
[Solidity Data Types](https://docs.soliditylang.org/en/latest/types.html)
in the `type` field of the definitions.

Please refer to the linked documentation for the OpenAPI and JSON Schema for
more information on the syntax of this field.

### Output Object

Describes a possible output of the operation.

| Field Name  | Type   | Description |
| ----------- | ------ | ----------- |
| summary     | string | A short summary of the Output. |
| description | string | A description for the tag. Markdown may be used for tich text representation. |
| type        | string | **REQUIRED**. The type of the output. Either `notice`, `report`, or `voucher`. |
| index       | int    | If the order of the outputs is important for the operation, this field may be used to describe the index that the current described output should appear. The index should be relative to the `type`, and the first output of each type should be indexed as zero. |
| required    | bool   | True if this operation should always return this output, or false if this output is optional. By default, the value is `false`. |

According to the type of the output, other fields can be supplied.

For `notice` and `report` outputs:

| Field Name  | Type   | Description |
| ----------- | ------ | ----------- |
| contentType | string | **REQUIRED**. The content type. See the discussion in the [Input Object](#input-object) description for more information on the contents of this field. |
| schema      | [Schema Object](#schema-object) | The schema for the current output, if the content type is a structured data format. |

For `voucher` outputs:

| Field Name  | Type   | Description |
| ----------- | ------ | ----------- |
| contract    | [Address Object](#address-object) | If this operation always generates a voucher to the same contract, this field may be used to represent its address. |
| methodSignature | string | The signature of the method that this voucher sends data to. |

If the operation type is `inspect`, the only output type allowed is `report`.

### Address Object

Describes an Ethereum EOA (wallet) or contract addresses.

| Field Name | Type   | Description |
| ---------- | ------ | ----------- |
| summary    | string | A short summary of the Address. |
| address    | string | The address in a 42-character hexadecimal notation, and starting with the "0x" prefix. Ethereum addresses are case-insensitive, but the notation SHOULD use the [EIP-55](https://eips.ethereum.org/EIPS/eip-55) mixed-case checksum. |
| ens        | string | An Ethereum Name Service compatible address. |

### Tag Object

Adds metadata to a single tag. It is not mandatory to have a Tag Object per tag.

Fields:

| Field Name | Type   | Description |
| ---------- | ------ | ----------- |
| name       | string | **REQUIRED**. Name of the Tag. |
| description | string | A description for the tag. Markdown may be used for tich text representation. |
| externalDocs | [External Documentation Object](#external-documentation-object) | The email address of the contact person/organization |

### External Documentation Object

Reference for an external resource for extended documentation.

Fields:

| Field Name | Type   | Description |
| ---------- | ------ | ----------- |
| description | string | Description for the target documentation. Markdown may be used for rich text representation. |
| url        | string | The URL pointing to the documentation. |

### Components Object

Holds a set of reusable objects for different aspects of the Cartesi API
Specification. The objects defined within the components object will have no
effect unless explicitly referenced from outside, using a
[Reference Object](#reference-object).

Fields:

| Field Name | Type   | Description |
| ---------- | ------ | ----------- |
| schemas    | Map\[string, [Schema Object](#schema-object)\] | An object to hold reusable Schema Objects |
| inputs     | Map\[string, [Input Object](#input-object)\] | An object to hold reusable Input Objects |
| addresses  | Map\[string, [Address Object](#input-object)\] | An object to hold reusable Address Objects |

### Reference Object

A simple object to allow referencing other components in the document.

Fields:

| Field Name | Type   | Description |
| ---------- | ------ | ----------- |
| $ref       | string | **REQUIRED**. The reference identifier. This MUST be in the form of a RFC3986 URI |
| summary    | string | A short summary which should override that of the referenced component. If the referenced object type does not allow a `summary` field, then this field has no effect. |
| description | string | A description which should override that of the referenced component. Markdown may be used for rich text representation. If the referenced object type does not allow a `description` field, then this field has no effect. |

## Future works on the documentation

- Add provision for a structured field to link to the source code of the implementation of each operation.
- Make the most important fields more visibile
